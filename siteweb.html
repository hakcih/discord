<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Drum Grid</title>

<style>
body {
    background:#0a0a0a;
    color:white;
    font-family:Arial, sans-serif;
    text-align:center;
}

.controls {
    margin:20px;
}

.grid {
    display:grid;
    grid-template-columns: 80px repeat(16, 32px);
    gap:6px;
    justify-content:center;
}

.track {
    font-size:12px;
    text-align:right;
    padding-right:6px;
}

.step {
    width:32px;
    height:32px;
    background:#222;
    cursor:pointer;
    border-radius:4px;
    transition:background .12s;
}

.step.active {
    background:#1db954;
}

.step.playing {
    outline:2px solid white;
}

#status {
    margin-top:10px;
    font-weight:bold;
    color:#ffd27a;
}
</style>
</head>

<body>

<h2>ðŸŽ› Drum Grid</h2>

<div class="controls">
    <button id="play">â–¶ Play</button>
    BPM <input type="number" id="bpm" value="120" min="30" max="300" style="width:70px">
</div>

<div class="grid" id="grid" aria-label="Grille de batterie"></div>

<!-- BOUTON FINISH IA -->
<div style="margin-top:30px;">
    <button id="finish">ðŸ¤– Finish â€“ Ã‰valuation IA</button>
    <div id="status" role="status" aria-live="polite"></div>
</div>

<script>
/* ---------- SONS (chemins relatifs) ---------- */
const tracks = [
    { name:"Kick", file:"asset/Kick VY 48.wav" },
    { name:"Snare", file:"asset/Snare VY 08.wav" },
    { name:"Snare 2", file:"asset/Snare VY 53.wav" },
    { name:"Hat", file:"asset/Hat VY 32.wav" },
    { name:"Bass", file:"asset/Free Bass Samples - 020.wav" }
];

const steps = 16;
let stepIndex = 0;
let playing = false;
let timer = null;

const grid = document.getElementById("grid");
const playBtn = document.getElementById("play");
const bpmInput = document.getElementById("bpm");
const status = document.getElementById("status");

/* ---------- PRECHARGER LES SONS ---------- */
tracks.forEach(t => {
    // crÃ©e un objet audio pour prÃ©chargement et rÃ©utilisation
    t.audioPool = [];
    for (let i = 0; i < 6; i++) { // petit pool pour permettre notes rapides
        const a = new Audio(t.file);
        a.preload = 'auto';
        t.audioPool.push(a);
    }
    t.poolIndex = 0;
});

/* ---------- CRÃ‰ATION GRILLE ---------- */
tracks.forEach(track => {
    const label = document.createElement("div");
    label.textContent = track.name;
    label.className = "track";
    grid.appendChild(label);

    for (let i = 0; i < steps; i++) {
        const cell = document.createElement("div");
        cell.className = "step";
        cell.setAttribute('role','button');
        cell.setAttribute('aria-pressed','false');
        cell.tabIndex = 0;
        cell.addEventListener("click", () => {
            cell.classList.toggle("active");
            cell.setAttribute('aria-pressed', String(cell.classList.contains('active')));
        });
        cell.addEventListener("keydown", (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                cell.click();
            }
        });
        grid.appendChild(cell);
    }
});

const allSteps = document.querySelectorAll(".step");

/* ---------- LECTURE ---------- */
function playStep() {
    allSteps.forEach(s => s.classList.remove("playing"));

    tracks.forEach((track, t) => {
        const index = t * steps + stepIndex;
        const cell = allSteps[index];
        if (!cell) return;

        cell.classList.add("playing");

        if (cell.classList.contains("active")) {
            // utilise le pool audio pour Ã©viter latence et coupures
            const pool = track.audioPool;
            const a = pool[track.poolIndex % pool.length];
            track.poolIndex++;
            try {
                a.currentTime = 0;
            } catch (err) {
                // certains navigateurs bloquent currentTime avant interaction, on ignore
            }
            a.play().catch(() => {
                // play() peut Ãªtre bloquÃ© si pas d'interaction utilisateur ; on ignore silencieusement
            });
        }
    });

    stepIndex = (stepIndex + 1) % steps;
}

function startPlayback() {
    const bpm = Math.max(30, Math.min(300, Number(bpmInput.value) || 120));
    const interval = (60 / bpm) * 1000 / 4; // 16 steps per bar (4 subdivisions)
    if (timer) clearInterval(timer);
    timer = setInterval(playStep, interval);
    playing = true;
    playBtn.textContent = "â¸ Stop";
    status.textContent = "Lecture en cours";
}

function stopPlayback() {
    if (timer) clearInterval(timer);
    timer = null;
    playing = false;
    stepIndex = 0;
    playBtn.textContent = "â–¶ Play";
    allSteps.forEach(s => s.classList.remove("playing"));
    status.textContent = "ArrÃªtÃ©";
}

playBtn.addEventListener('click', () => {
    // Demande interaction utilisateur pour autoriser audio sur certains navigateurs
    if (!playing) {
        startPlayback();
    } else {
        stopPlayback();
    }
});

/* ---------- FINISH IA (redirection relative) ---------- */
const finishBtn = document.getElementById("finish");

finishBtn.onclick = () => {
    status.textContent = "â³ Analyse IA du beat...";
    finishBtn.disabled = true;

    setTimeout(() => {
        status.textContent = "Analyse terminÃ©e â€” rÃ©sultat : intÃ©ressant";
    }, 2000);

    // redirection relative vers 2.html (doit exister Ã  la racine du dÃ©pÃ´t)
    setTimeout(() => {
        window.location.href = "2.html";
    }, 3500);
};

/* ---------- Astuce : sauvegarde / chargement (optionnel) ---------- */
/* Exemple simple pour exporter l'Ã©tat de la grille en JSON dans la console */
function exportPattern() {
    const pattern = [];
    for (let t = 0; t < tracks.length; t++) {
        const row = [];
        for (let s = 0; s < steps; s++) {
            const idx = t * steps + s;
            row.push(allSteps[idx].classList.contains('active') ? 1 : 0);
        }
        pattern.push(row);
    }
    return pattern;
}

/* raccourci clavier : E pour exporter pattern dans la console */
document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'e') {
        console.log('Pattern export:', exportPattern());
        status.textContent = 'Pattern exportÃ© dans la console';
        setTimeout(() => status.textContent = '', 1500);
    }
});
</script>

</body>
</html>
